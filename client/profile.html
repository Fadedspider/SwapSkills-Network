<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Profile | SkillSwap</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    input, select { display: block; margin: 10px 0; padding: 8px; width: 300px; }
    .skill-tag { display: inline-block; margin: 4px; padding: 6px; background: #eee; border-radius: 4px; }
    .remove-skill { margin-left: 6px; cursor: pointer; }
    #toast { background: #333; color: white; padding: 10px; position: fixed; bottom: 10px; left: 10px; display: none; }
  </style>
</head>
<body>

<h1>My Profile</h1>
<input type="text" id="name" placeholder="Full Name" />
<input type="text" id="location" placeholder="Location" />
<input type="text" id="addSkillOffered" placeholder="Skill Offered (press Enter)" onkeydown="addSkill(event, 'offered')" />
<div id="skillsOffered"></div>

<input type="text" id="addSkillWanted" placeholder="Skill Wanted (press Enter)" onkeydown="addSkill(event, 'wanted')" />
<div id="skillsWanted"></div>

<select id="availability">
  <option value="weekends">Weekends</option>
  <option value="weekdays">Weekdays</option>
</select>

<select id="profileStatus">
  <option value="public">Public</option>
  <option value="private">Private</option>
</select>

<button onclick="saveProfile()">Save Profile</button>
<button onclick="logout()">Logout</button>

<div id="toast"></div>

<script type="module">
  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

  const supabase = createClient(
    'https://vaqytztdyddmjurvdcnr.supabase.co',
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZhcXl0enRkeWRkbWp1cnZkY25yIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIyOTcxMjMsImV4cCI6MjA2Nzg3MzEyM30.HulF-xChijgYKXMqDhWTiDrHhIWLpBbDLIJGO7tX29M'
  );

  let userId = null;
  let profile = {
    name: "",
    location: "",
    skillsOffered: [],
    skillsWanted: [],
    availability: "weekends",
    profileStatus: "public"
  };

  async function getUserAndProfile() {
    const { data: { user } } = await supabase.auth.getUser();
    if (!user) {
      showToast("You must be logged in.");
      return;
    }
    userId = user.id;

    const { data, error } = await supabase
      .from('profiles')
      .select('*')
      .eq('id', userId)
      .single();

    if (data) {
      profile = {
        name: data.full_name || "",
        location: data.location || "",
        skillsOffered: data.skills_offered || [],
        skillsWanted: data.skills_wanted || [],
        availability: data.availability || "weekends",
        profileStatus: data.profile_status || "public"
      };
    }

    renderProfile();
  }

  function renderProfile() {
    document.getElementById('name').value = profile.name;
    document.getElementById('location').value = profile.location;
    document.getElementById('availability').value = profile.availability;
    document.getElementById('profileStatus').value = profile.profileStatus;
    renderSkills('skillsOffered', profile.skillsOffered, 'offered');
    renderSkills('skillsWanted', profile.skillsWanted, 'wanted');
  }

  function renderSkills(containerId, skills, type) {
    const container = document.getElementById(containerId);
    container.innerHTML = '';
    skills.forEach((skill, idx) => {
      const tag = document.createElement('div');
      tag.className = 'skill-tag';
      tag.innerHTML = `${skill} <span class="remove-skill" onclick="removeSkill('${type}', ${idx})">&times;</span>`;
      container.appendChild(tag);
    });
  }

  window.addSkill = function (e, type) {
    if (e.key === "Enter") {
      e.preventDefault();
      const inputId = type === 'offered' ? 'addSkillOffered' : 'addSkillWanted';
      const skill = document.getElementById(inputId).value.trim();
      if (skill) {
        if (type === 'offered') profile.skillsOffered.push(skill);
        else profile.skillsWanted.push(skill);
        document.getElementById(inputId).value = '';
        renderProfile();
      }
    }
  }

  window.removeSkill = function (type, idx) {
    if (type === 'offered') profile.skillsOffered.splice(idx, 1);
    else profile.skillsWanted.splice(idx, 1);
    renderProfile();
  }

  window.saveProfile = async function () {
    profile.name = document.getElementById('name').value;
    profile.location = document.getElementById('location').value;
    profile.availability = document.getElementById('availability').value;
    profile.profileStatus = document.getElementById('profileStatus').value;

    const { error } = await supabase
      .from('profiles')
      .upsert([{
        id: userId,
        full_name: profile.name,
        location: profile.location,
        skills_offered: profile.skillsOffered,
        skills_wanted: profile.skillsWanted,
        availability: profile.availability,
        profile_status: profile.profileStatus
      }]);

    if (error) showToast("Save failed");
    else showToast("Profile saved!");
  }

  window.logout = async function () {
    await supabase.auth.signOut();
    window.location.href = "login.html";
  }

  function showToast(msg) {
    const toast = document.getElementById('toast');
    toast.textContent = msg;
    toast.style.display = 'block';
    setTimeout(() => toast.style.display = 'none', 2000);
  }

  getUserAndProfile();
</script>
</body>
</html>
